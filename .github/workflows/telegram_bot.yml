name: Telegram Bot Service

on:
  push:
    branches: [ main, master ]
    paths:
      - 'telegram_bot.py'
      - '.github/workflows/telegram_bot.yml'
  workflow_dispatch:  # ‡∏£‡∏±‡∏ô manually
  schedule:
    # Keep-alive: ‡∏£‡∏±‡∏ô‡∏ó‡∏∏‡∏Å 5 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó Bot
    - cron: '0 */5 * * *'

jobs:
  run-telegram-bot:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v3
    
    - name: üêç Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: üìö Install dependencies
      run: |
        echo "üìö Installing dependencies..."
        pip install --upgrade pip
        pip install python-telegram-bot[all]==21.0 supabase requests
        echo "‚úÖ Dependencies installed"
    
    - name: ü§ñ Start Telegram Bot
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      timeout-minutes: 300  # ‡∏£‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (GitHub Actions limit = 6 hrs)
      run: |
        echo "ü§ñ Starting Telegram Bot..."
        echo "Bot will run for up to 5 hours"
        python Telegram_bot.py &
        BOT_PID=$!
        echo "Bot PID: $BOT_PID"
        
        # ‡∏£‡∏≠ 5 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (18000 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
        sleep 18000
        
        # ‡∏´‡∏¢‡∏∏‡∏î Bot ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏á‡πà‡∏≤‡∏á‡∏≤‡∏°
        echo "‚è∞ Time limit reached, stopping bot..."
        kill $BOT_PID 2>/dev/null || true
        echo "‚úÖ Bot stopped gracefully"
    
    - name: ‚ùå Notify on Failure
      if: failure()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        curl -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d "chat_id=${TELEGRAM_CHAT_ID}" \
          -d "text=‚ùå Telegram Bot Crashed!%0A%0AWorkflow: ${GITHUB_WORKFLOW}%0ARun: ${GITHUB_RUN_NUMBER}%0A%0ACheck logs: https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
